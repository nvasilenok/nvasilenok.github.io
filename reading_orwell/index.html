<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reading Orwell in Moscow</title>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

</head>
<body>
  <h1>Reading Orwell in Moscow</h1>
  <h2>Chronicle of Book Censorship in Contemporary Russia</h2>
  <div id="category-buttons"></div>
  <div id="entries"></div>

  <script>
    let entries = [];
    let currentCategory = 'full timeline';

    fetch('entries.json')
      .then(response => response.json())
      .then(data => {
        entries = data.filter(entry => entry.public === 1);
        entries.sort((a, b) => new Date(b.date_parsed) - new Date(a.date_parsed));
        const types = Array.from(new Set(entries.map(e => e.type)));
        renderCategoryButtons(['full timeline', ...types]);
        displayEntries(currentCategory);
      })
      .catch(error => {
        document.getElementById('entries').textContent = 'Failed to load entries.';
        console.error(error);
      });

      function renderCategoryButtons(categories) {
        const container = document.getElementById('category-buttons');
        container.innerHTML = '';
        categories.forEach(cat => {
          const btn = document.createElement('button');
          btn.textContent = cat;
          btn.onclick = () => {
            currentCategory = cat;
            displayEntries(cat);
            document.querySelectorAll('#category-buttons button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
          };
          if (cat === currentCategory) {
            btn.classList.add('active');
          }
          container.appendChild(btn);
        });
      }

    function displayEntries(category) {
      const container = document.getElementById('entries');
      container.innerHTML = '';
    
      const filtered = category === 'full timeline'
        ? entries
        : entries.filter(entry => entry.type === category);
    
      let currentYear = '';
    
      filtered.forEach(entry => {
        const entryYear = new Date(entry.date_parsed).getFullYear().toString();
    
        // Insert a year header if we haven't already for this group
        if (entryYear !== currentYear) {
          currentYear = entryYear;
          const yearHeader = document.createElement('div');
          yearHeader.className = 'year-header';
          yearHeader.textContent = currentYear;
          container.appendChild(yearHeader);
        }
    
        const entryDiv = document.createElement('div');
        entryDiv.className = 'entry';
    
        if (currentCategory === 'full timeline') {
          const typeElem = document.createElement('div');
          typeElem.classList.add('entry-type');
          typeElem.textContent = entry.type;
          entryDiv.appendChild(typeElem);
        }
    
        const dateElem = document.createElement('div');
        dateElem.className = 'entry-date';
        dateElem.textContent = entry.date;
    
        const descElem = document.createElement('p');
        descElem.innerHTML = entry.description;
    
        entryDiv.appendChild(dateElem);
        entryDiv.appendChild(descElem);
    
        // Source logic
        if (entry.source && entry.source !== '') {
          const sourceContainer = document.createElement('div');
          sourceContainer.classList.add('entry-source');
    
          if (entry.source === 'url') {
            ['url1', 'url2', 'url3'].forEach((key, i) => {
              if (entry[key] && entry[key].trim() !== '') {
                const link = document.createElement('a');
                link.href = entry[key];
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
                link.textContent = '[source]';
                link.classList.add('source-link');
                sourceContainer.appendChild(link);
    
                if (i < 2 && entry[key + 1] && entry[key + 1].trim() !== '') {
                  const spacer = document.createTextNode(' ');
                  sourceContainer.appendChild(spacer);
                }
              }
            });
          } else {
            sourceContainer.textContent = entry.source;
          }
    
          entryDiv.appendChild(sourceContainer);
        }
    
        if (entry.location && entry.location.trim() !== '') {
          const locationElem = document.createElement('div');
          locationElem.classList.add('entry-location');

          const icon = document.createElement('i');
          icon.className = 'fa fa-location-arrow';
          icon.setAttribute('aria-hidden', 'true');

          locationElem.appendChild(icon);
          locationElem.appendChild(document.createTextNode(' ' + entry.location));

          entryDiv.appendChild(locationElem);
        }
        container.appendChild(entryDiv);
      });
}
  </script>
</body>
</html>

